---
- hosts: all
  tasks:
    # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/tempfile_module.html
    - name: Create temporary build directory for generated scripts
      ansible.builtin.tempfile:
        state: directory
        suffix: build

    - name: Create temporary file for generated scripts
      ansible.builtin.tempfile:
        state: file
        suffix: temp
      register: tempfile_1

    # TODO Execute commands from file generated by a template
    - name: Script to copy public key
      connection: local
      template:
        src: ssh-copy-id.j2
        dest: "{{ tempfile_1.path }}"

    - name: Set up public key authentication for `servers` using script
      connection: local
      shell: sh "{{ tempfile_1.path }}"

    - name: Set up public key authentication for `servers` using inline script
      connection: local
      # https://adamo.wordpress.com/2020/04/09/temporarily-disabling-an-ansible-task-in-a-playbook/
      when: 0 > 1
      shell: |
        exit 0
        {% set ips = [] %}
        {%for server in groups['servers'] %}
          {{ ips.append(hostvars[server]['ansible_host']) }}
        {% endfor %}
        for ip in {{ ips|join(' ') }}
        do 
          ssh-copy-id -i $HOME/.ssh/*.pub ${USER}@${ip}
        done

    - name: Remove file (delete file)
      ansible.builtin.file:
        path: /root/.ssh/authorized_keys
        state: absent

    - name: Set public key authentication for root
      become: yes
      vars:
        filename: authorized_keys
      ansible.builtin.copy:
        src:  /home/{{ lookup('env', 'USER') }}/.ssh/{{filename}}
        dest: /root/.ssh/{{filename}}
        mode: u+rw,g-rwx,o-rwx
        remote_src: yes
